name: Dependabot Auto-merge

on:
  pull_request:
    types: [opened, synchronize, labeled]

jobs:
  # æ£€æŸ¥ä¾èµ–æ›´æ–°å®‰å…¨æ€§
  check-dependency-safety:
    name: Check Dependency Safety
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    outputs:
      is-safe: ${{ steps.check.outputs.is-safe }}
      dependency-type: ${{ steps.check.outputs.dependency-type }}
      update-type: ${{ steps.check.outputs.update-type }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check dependency safety
      id: check
      run: |
        # æ£€æŸ¥æ˜¯å¦ä¸ºå®‰å…¨çš„ä¾èµ–æ›´æ–°
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_BODY="${{ github.event.pull_request.body }}"
        
        echo "PR Title: $PR_TITLE"
        echo "PR Body: $PR_BODY"
        
        # æ£€æŸ¥æ›´æ–°ç±»å‹
        if echo "$PR_TITLE" | grep -q "Bump.*from.*to.*"; then
          echo "dependency-type=direct" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºpatchç‰ˆæœ¬æ›´æ–°
          if echo "$PR_TITLE" | grep -q "patch\|bugfix"; then
            echo "update-type=patch" >> $GITHUB_OUTPUT
            echo "is-safe=true" >> $GITHUB_OUTPUT
            echo "âœ… Patch version update - safe to auto-merge"
          else
            echo "update-type=minor" >> $GITHUB_OUTPUT
            echo "is-safe=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Minor version update - requires manual review"
          fi
        else
          echo "dependency-type=unknown" >> $GITHUB_OUTPUT
          echo "update-type=unknown" >> $GITHUB_OUTPUT
          echo "is-safe=false" >> $GITHUB_OUTPUT
          echo "âŒ Unknown update type - requires manual review"
        fi

  # è‡ªåŠ¨åˆå¹¶å®‰å…¨çš„ä¾èµ–æ›´æ–°
  auto-merge:
    name: Auto-merge Safe Dependencies
    runs-on: ubuntu-latest
    needs: [check-dependency-safety]
    if: github.actor == 'dependabot[bot]' && needs.check-dependency-safety.outputs.is-safe == 'true' && contains(github.event.pull_request.labels.*.name, 'auto-merge')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run tests before merge
      run: |
        echo "ğŸ§ª Running tests before auto-merge..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ æµ‹è¯•å‘½ä»¤
        # ./mvnw clean test
        
    - name: Auto-merge Dependabot PRs
      uses: fastify/github-action-merge-dependabot@v3
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        target: patch  # ä»…è‡ªåŠ¨åˆå¹¶patchç‰ˆæœ¬
        merge-method: squash
        
    - name: Notify merge
      if: success()
      run: |
        echo "âœ… Safe dependency update merged successfully"
        echo "PR: ${{ github.event.pull_request.html_url }}"
        echo "Title: ${{ github.event.pull_request.title }}"
        echo "Update Type: ${{ needs.check-dependency-safety.outputs.update-type }}"

  # é€šçŸ¥éœ€è¦æ‰‹åŠ¨å®¡æŸ¥çš„æ›´æ–°
  notify-manual-review:
    name: Notify Manual Review Required
    runs-on: ubuntu-latest
    needs: [check-dependency-safety]
    if: github.actor == 'dependabot[bot]' && needs.check-dependency-safety.outputs.is-safe == 'false'
    
    steps:
    - name: Notify manual review
      run: |
        echo "âš ï¸ Manual review required for dependency update"
        echo "PR: ${{ github.event.pull_request.html_url }}"
        echo "Title: ${{ github.event.pull_request.title }}"
        echo "Dependency Type: ${{ needs.check-dependency-safety.outputs.dependency-type }}"
        echo "Update Type: ${{ needs.check-dependency-safety.outputs.update-type }}"
        echo ""
        echo "Please review the changes and merge manually if safe."
