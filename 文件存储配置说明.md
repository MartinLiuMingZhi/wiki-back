# Wiki知识库 - 文件存储配置说明

## 📁 存储方案

### 主要方案：七牛云对象存储
- **优势**：高可用、高并发、CDN加速、成本低
- **适用场景**：生产环境、高并发访问
- **配置**：通过`file.storage.type=qiniu`启用

### 备选方案：本地文件存储
- **优势**：简单、无外部依赖、开发测试方便
- **适用场景**：开发环境、测试环境、小规模应用
- **配置**：通过`file.storage.type=local`启用

## ⚙️ 配置说明

### 1. 七牛云配置

在`application.properties`中配置七牛云参数：

```properties
# 文件存储类型：qiniu 或 local
file.storage.type=qiniu

# 七牛云配置
qiniu.access-key=your_access_key_here
qiniu.secret-key=your_secret_key_here
qiniu.bucket=your_bucket_name
qiniu.domain=https://your-domain.com
qiniu.region=huadong
```

#### 七牛云配置获取步骤：

1. **注册七牛云账号**
   - 访问：https://www.qiniu.com/
   - 注册并完成实名认证

2. **创建存储空间**
   - 登录七牛云控制台
   - 进入"对象存储" -> "空间管理"
   - 创建新的存储空间
   - 记录存储空间名称（bucket）

3. **获取AccessKey和SecretKey**
   - 进入"个人中心" -> "密钥管理"
   - 创建新的AccessKey和SecretKey
   - 记录AccessKey和SecretKey

4. **配置域名**
   - 在存储空间设置中配置自定义域名
   - 或者使用七牛云提供的默认域名
   - 记录域名地址

5. **选择存储区域**
   - 华东：huadong
   - 华北：huabei
   - 华南：huanan
   - 北美：beimei
   - 东南亚：dongnanya

### 2. 本地存储配置

```properties
# 文件存储类型
file.storage.type=local

# 本地存储配置
file.upload.path=/uploads
file.upload.max-size=104857600
```

## 🚀 功能特性

### 七牛云存储特性

1. **自动上传**
   - 文件直接上传到七牛云
   - 返回七牛云文件URL
   - 支持CDN加速访问

2. **预签名上传**
   - 生成上传Token
   - 前端直传七牛云
   - 减少服务器压力

3. **文件管理**
   - 文件信息查询
   - 文件删除
   - 访问权限控制

4. **下载处理**
   - 重定向到七牛云URL
   - 支持CDN加速
   - 自动处理文件类型

### 本地存储特性

1. **简单上传**
   - 文件保存到本地目录
   - 返回本地文件路径
   - 适合开发测试

2. **文件管理**
   - 本地文件操作
   - 文件信息查询
   - 文件删除

3. **下载处理**
   - 直接返回文件流
   - 支持断点续传
   - 自动处理文件类型

## 📋 API接口

### 文件上传接口

```bash
# 直接上传
POST /api/v1/files/upload
Content-Type: multipart/form-data
参数：
- file: 文件
- folder: 文件夹（可选，默认general）

# 预签名上传
POST /api/v1/files/upload-url
Content-Type: application/json
参数：
{
  "fileName": "example.jpg",
  "contentType": "image/jpeg",
  "folder": "images"
}

# 确认上传
POST /api/v1/files/confirm-upload
Content-Type: application/json
参数：
{
  "fileKey": "images/1/2024/01/01/20240101120000_abc123.jpg",
  "fileSize": 1024000
}
```

### 文件下载接口

```bash
# 下载文件
GET /api/v1/files/download/{fileKey}

# 获取文件信息
GET /api/v1/files/info/{fileKey}

# 检查文件存在
GET /api/v1/files/exists/{fileKey}

# 删除文件
DELETE /api/v1/files/{fileKey}
```

## 🔧 开发配置

### 开发环境配置

```properties
# 开发环境使用本地存储
file.storage.type=local
file.upload.path=./uploads
file.upload.max-size=104857600
```

### 生产环境配置

```properties
# 生产环境使用七牛云
file.storage.type=qiniu
qiniu.access-key=your_production_access_key
qiniu.secret-key=your_production_secret_key
qiniu.bucket=your_production_bucket
qiniu.domain=https://your-production-domain.com
qiniu.region=huadong
```

## 📊 性能对比

| 特性 | 七牛云存储 | 本地存储 |
|------|------------|----------|
| 可用性 | 99.9%+ | 依赖服务器 |
| 并发性能 | 高 | 中等 |
| 存储容量 | 无限制 | 受服务器限制 |
| 访问速度 | CDN加速 | 受带宽限制 |
| 成本 | 按量计费 | 服务器成本 |
| 维护成本 | 低 | 中等 |

## 🛠️ 故障处理

### 七牛云故障处理

1. **上传失败**
   - 检查AccessKey和SecretKey是否正确
   - 检查存储空间是否存在
   - 检查网络连接是否正常

2. **下载失败**
   - 检查域名配置是否正确
   - 检查文件是否存在
   - 检查CDN配置

3. **权限问题**
   - 检查存储空间权限设置
   - 检查域名访问权限
   - 检查文件访问策略

### 本地存储故障处理

1. **上传失败**
   - 检查目录权限
   - 检查磁盘空间
   - 检查文件大小限制

2. **下载失败**
   - 检查文件是否存在
   - 检查文件权限
   - 检查服务器配置

## 📝 最佳实践

### 1. 文件命名规范
```
格式：{folder}/{userId}/{year}/{month}/{day}/{timestamp}_{uuid}.{ext}
示例：images/1/2024/01/01/20240101120000_abc123.jpg
```

### 2. 文件类型限制
```java
// 允许的文件类型
private static final Set<String> ALLOWED_EXTENSIONS = Set.of(
    "jpg", "jpeg", "png", "gif", "pdf", "doc", "docx", 
    "txt", "zip", "rar", "mp4", "avi", "mov"
);
```

### 3. 文件大小限制
```properties
# 单个文件最大100MB
file.upload.max-size=104857600
spring.servlet.multipart.max-file-size=100MB
```

### 4. 安全考虑
- 文件类型验证
- 文件大小限制
- 用户权限检查
- 恶意文件检测

## 🔄 切换存储方案

### 从本地存储切换到七牛云

1. **配置七牛云参数**
2. **修改配置**：`file.storage.type=qiniu`
3. **重启应用**
4. **迁移现有文件**（可选）

### 从七牛云切换到本地存储

1. **修改配置**：`file.storage.type=local`
2. **配置本地路径**：`file.upload.path=/uploads`
3. **重启应用**
4. **下载七牛云文件到本地**（可选）

## 📞 技术支持

- **七牛云技术支持**：https://support.qiniu.com/
- **七牛云文档**：https://developer.qiniu.com/
- **项目GitHub**：https://github.com/your-repo/wiki

---

通过以上配置，Wiki知识库系统可以灵活地使用七牛云对象存储或本地文件存储，满足不同环境的需求。
