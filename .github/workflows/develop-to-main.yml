name: Develop to Main Auto Merge

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      force_merge:
        description: 'Force merge even if conflicts exist'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  # æ£€æŸ¥åˆå¹¶æ¡ä»¶
  check-merge-conditions:
    name: Check Merge Conditions
    runs-on: ubuntu-latest
    outputs:
      can-merge: ${{ steps.check.outputs.can-merge }}
      has-conflicts: ${{ steps.check.outputs.has-conflicts }}
      is-behind: ${{ steps.check.outputs.is-behind }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global pull.rebase false
        
    - name: Check merge conditions
      id: check
      run: |
        echo "ğŸ” Checking merge conditions..."
        
        # è·å–æœ€æ–°ä¿¡æ¯
        git fetch origin
        
        # æ£€æŸ¥developåˆ†æ”¯çŠ¶æ€
        git checkout develop
        git pull origin develop
        
        # æ£€æŸ¥mainåˆ†æ”¯çŠ¶æ€
        git checkout main
        git pull origin main
        
        # æ£€æŸ¥developæ˜¯å¦å·²ç»åˆå¹¶åˆ°main
        if git merge-base --is-ancestor develop main; then
          echo "can-merge=false" >> $GITHUB_OUTPUT
          echo "is-behind=false" >> $GITHUB_OUTPUT
          echo "has-conflicts=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ develop is already merged into main"
          exit 0
        fi
        
        # æ£€æŸ¥mainæ˜¯å¦è½åäºdevelop
        BEHIND_COUNT=$(git rev-list --count main..develop)
        if [ "$BEHIND_COUNT" -gt 0 ]; then
          echo "is-behind=true" >> $GITHUB_OUTPUT
          echo "ğŸ“Š main is $BEHIND_COUNT commits behind develop"
        else
          echo "is-behind=false" >> $GITHUB_OUTPUT
          echo "ğŸ“Š main is up to date with develop"
        fi
        
        # æ£€æŸ¥åˆå¹¶å†²çª
        git checkout develop
        if git merge-tree $(git merge-base develop main) develop main | grep -q "<<<<<<<"; then
          echo "has-conflicts=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ Merge conflicts detected"
          HAS_CONFLICTS="true"
        else
          echo "has-conflicts=false" >> $GITHUB_OUTPUT
          echo "âœ… No merge conflicts detected"
          HAS_CONFLICTS="false"
        fi
        
        # å†³å®šæ˜¯å¦å¯ä»¥åˆå¹¶
        FORCE_MERGE="${{ github.event.inputs.force_merge }}"
        if [ "$HAS_CONFLICTS" = "true" ] && [ "$FORCE_MERGE" != "true" ]; then
          echo "can-merge=false" >> $GITHUB_OUTPUT
          echo "âŒ Cannot merge due to conflicts"
        else
          echo "can-merge=true" >> $GITHUB_OUTPUT
          echo "âœ… Can proceed with merge"
        fi

  # æ‰§è¡Œåˆå¹¶
  perform-merge:
    name: Perform Merge
    runs-on: ubuntu-latest
    needs: [check-merge-conditions]
    if: needs.check-merge-conditions.outputs.can-merge == 'true'
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global pull.rebase false
        
    - name: Perform merge
      run: |
        echo "ğŸ”„ Performing merge from develop to main..."
        
        # è·å–æœ€æ–°ä¿¡æ¯
        git fetch origin
        
        # åˆ‡æ¢åˆ°mainåˆ†æ”¯
        git checkout main
        git pull origin main
        
        # æ‰§è¡Œåˆå¹¶
        if [ "${{ needs.check-merge-conditions.outputs.has-conflicts }}" = "true" ]; then
          echo "âš ï¸ Force merging despite conflicts"
          git merge develop --no-ff -m "Force merge develop to main

          - Source: develop
          - Target: main
          - Strategy: no-ff (force)
          - Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          - Workflow: ${{ github.workflow }}
          - Run ID: ${{ github.run_id }}
          - Note: This merge was forced due to conflicts"
        else
          echo "âœ… Normal merge without conflicts"
          git merge develop --no-ff -m "Merge develop to main

          - Source: develop
          - Target: main
          - Strategy: no-ff
          - Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          - Workflow: ${{ github.workflow }}
          - Run ID: ${{ github.run_id }}"
        fi
        
        # æ¨é€åˆå¹¶ç»“æœ
        git push origin main
        
        echo "âœ… Successfully merged develop into main"
        
    - name: Verify merge
      run: |
        echo "ğŸ” Verifying merge result..."
        
        # éªŒè¯åˆå¹¶æ˜¯å¦æˆåŠŸ
        if git merge-base --is-ancestor develop main; then
          echo "âœ… Merge verification successful"
        else
          echo "âŒ Merge verification failed"
          exit 1
        fi
        
        # æ˜¾ç¤ºåˆå¹¶ä¿¡æ¯
        echo "ğŸ“‹ Merge information:"
        echo "  - Source: develop"
        echo "  - Target: main"
        echo "  - Merge commit: $(git rev-parse HEAD)"
        echo "  - Previous main: $(git rev-parse HEAD~1)"
        
        # æ˜¾ç¤ºæœ€è¿‘çš„æäº¤
        echo "ğŸ“‹ Recent commits:"
        git log --oneline -5

  # è·³è¿‡åˆå¹¶
  skip-merge:
    name: Skip Merge
    runs-on: ubuntu-latest
    needs: [check-merge-conditions]
    if: needs.check-merge-conditions.outputs.can-merge == 'false'
    
    steps:
    - name: Skip merge notification
      run: |
        echo "â­ï¸ Skipping merge operation"
        echo "  - Can merge: ${{ needs.check-merge-conditions.outputs.can-merge }}"
        echo "  - Has conflicts: ${{ needs.check-merge-conditions.outputs.has-conflicts }}"
        echo "  - Is behind: ${{ needs.check-merge-conditions.outputs.is-behind }}"
        
        if [ "${{ needs.check-merge-conditions.outputs.has-conflicts }}" = "true" ]; then
          echo "âŒ Skipped due to merge conflicts"
          echo "ğŸ’¡ To force merge, use workflow_dispatch with force_merge=true"
        elif [ "${{ needs.check-merge-conditions.outputs.is-behind }}" = "false" ]; then
          echo "â„¹ï¸ Skipped because develop is already merged into main"
        else
          echo "âŒ Skipped due to unknown conditions"
        fi

  # æœ€ç»ˆé€šçŸ¥
  final-notification:
    name: Final Notification
    runs-on: ubuntu-latest
    needs: [check-merge-conditions, perform-merge, skip-merge]
    if: always()
    
    steps:
    - name: Create final notification
      run: |
        echo "ğŸ“¢ Develop to Main merge process completed"
        echo "  - Workflow: ${{ github.workflow }}"
        echo "  - Run ID: ${{ github.run_id }}"
        echo "  - Trigger: ${{ github.event_name }}"
        echo "  - Source: develop"
        echo "  - Target: main"
        echo "  - Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
        echo ""
        echo "ğŸ“Š Results:"
        echo "  - Check conditions: ${{ needs.check-merge-conditions.result }}"
        echo "  - Perform merge: ${{ needs.perform-merge.result }}"
        echo "  - Skip merge: ${{ needs.skip-merge.result }}"
        echo ""
        
        if [ "${{ needs.perform-merge.result }}" = "success" ]; then
          echo "âœ… Merge completed successfully"
        elif [ "${{ needs.skip-merge.result }}" = "success" ]; then
          echo "â­ï¸ Merge was skipped"
        else
          echo "âŒ Merge process failed"
        fi
