# WikiçŸ¥è¯†åº“ - æ–‡ä»¶å­˜å‚¨åŠŸèƒ½å®Œå–„æ€»ç»“

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

å·²æˆåŠŸå®ç°æ”¯æŒä¸ƒç‰›äº‘å¯¹è±¡å­˜å‚¨å’Œæœ¬åœ°æ–‡ä»¶å­˜å‚¨çš„åŒé‡æ–‡ä»¶ç®¡ç†æ–¹æ¡ˆï¼Œæ»¡è¶³ä¸åŒç¯å¢ƒçš„éœ€æ±‚ã€‚

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. å­˜å‚¨æ–¹æ¡ˆæ”¯æŒ

#### ä¸ƒç‰›äº‘å¯¹è±¡å­˜å‚¨ï¼ˆä¸»è¦æ–¹æ¡ˆï¼‰
- **ä¼˜åŠ¿**ï¼šé«˜å¯ç”¨ã€é«˜å¹¶å‘ã€CDNåŠ é€Ÿã€æˆæœ¬ä½
- **é€‚ç”¨åœºæ™¯**ï¼šç”Ÿäº§ç¯å¢ƒã€é«˜å¹¶å‘è®¿é—®
- **é…ç½®æ–¹å¼**ï¼š`file.storage.type=qiniu`

#### æœ¬åœ°æ–‡ä»¶å­˜å‚¨ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
- **ä¼˜åŠ¿**ï¼šç®€å•ã€æ— å¤–éƒ¨ä¾èµ–ã€å¼€å‘æµ‹è¯•æ–¹ä¾¿
- **é€‚ç”¨åœºæ™¯**ï¼šå¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€å°è§„æ¨¡åº”ç”¨
- **é…ç½®æ–¹å¼**ï¼š`file.storage.type=local`

### 2. æ ¸å¿ƒåŠŸèƒ½å®ç°

#### æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
- **ç›´æ¥ä¸Šä¼ **ï¼šæ”¯æŒMultipartFileç›´æ¥ä¸Šä¼ 
- **é¢„ç­¾åä¸Šä¼ **ï¼šç”Ÿæˆä¸ƒç‰›äº‘ä¸Šä¼ Tokenï¼Œæ”¯æŒå‰ç«¯ç›´ä¼ 
- **ä¸Šä¼ ç¡®è®¤**ï¼šéªŒè¯æ–‡ä»¶ä¸Šä¼ å®ŒæˆçŠ¶æ€
- **å­˜å‚¨åˆ‡æ¢**ï¼šæ ¹æ®é…ç½®è‡ªåŠ¨é€‰æ‹©å­˜å‚¨æ–¹æ¡ˆ

#### æ–‡ä»¶ä¸‹è½½åŠŸèƒ½
- **ä¸ƒç‰›äº‘ä¸‹è½½**ï¼šé‡å®šå‘åˆ°ä¸ƒç‰›äº‘CDN URL
- **æœ¬åœ°ä¸‹è½½**ï¼šç›´æ¥è¿”å›æ–‡ä»¶æµ
- **æƒé™æ§åˆ¶**ï¼šåŸºäºç”¨æˆ·æƒé™çš„æ–‡ä»¶è®¿é—®
- **æ–‡ä»¶ç±»å‹å¤„ç†**ï¼šè‡ªåŠ¨è¯†åˆ«æ–‡ä»¶ç±»å‹å’ŒMIMEç±»å‹

#### æ–‡ä»¶ç®¡ç†åŠŸèƒ½
- **æ–‡ä»¶ä¿¡æ¯æŸ¥è¯¢**ï¼šè·å–æ–‡ä»¶è¯¦ç»†ä¿¡æ¯
- **æ–‡ä»¶å­˜åœ¨æ£€æŸ¥**ï¼šéªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- **æ–‡ä»¶åˆ é™¤**ï¼šæ”¯æŒåˆ é™¤ä¸ƒç‰›äº‘å’Œæœ¬åœ°æ–‡ä»¶
- **æ–‡ä»¶å¤§å°è·å–**ï¼šè·å–æ–‡ä»¶å¤§å°ä¿¡æ¯

### 3. æŠ€æœ¯å®ç°

#### ä¾èµ–é…ç½®
```xml
<!-- ä¸ƒç‰›äº‘SDK -->
<dependency>
    <groupId>com.qiniu</groupId>
    <artifactId>qiniu-java-sdk</artifactId>
    <version>7.11.0</version>
</dependency>
```

#### é…ç½®æ–‡ä»¶
```properties
# æ–‡ä»¶å­˜å‚¨é…ç½®
file.storage.type=qiniu
file.upload.path=/uploads
file.upload.max-size=104857600

# ä¸ƒç‰›äº‘é…ç½®
qiniu.access-key=your_access_key
qiniu.secret-key=your_secret_key
qiniu.bucket=your_bucket_name
qiniu.domain=https://your-domain.com
qiniu.region=huadong
```

## ğŸ“‹ APIæ¥å£

### æ–‡ä»¶ä¸Šä¼ æ¥å£

#### 1. ç›´æ¥ä¸Šä¼ 
```bash
POST /api/v1/files/upload
Content-Type: multipart/form-data

å‚æ•°ï¼š
- file: æ–‡ä»¶ï¼ˆå¿…éœ€ï¼‰
- folder: æ–‡ä»¶å¤¹ï¼ˆå¯é€‰ï¼Œé»˜è®¤generalï¼‰

å“åº”ï¼š
{
  "code": 200,
  "message": "ä¸Šä¼ æˆåŠŸ",
  "data": {
    "fileKey": "images/1/2024/01/01/20240101120000_abc123.jpg",
    "fileName": "example.jpg",
    "fileSize": 1024000,
    "contentType": "image/jpeg",
    "uploadTime": "2024-01-01T12:00:00",
    "url": "https://your-domain.com/images/1/2024/01/01/20240101120000_abc123.jpg",
    "storageType": "qiniu"
  }
}
```

#### 2. é¢„ç­¾åä¸Šä¼ 
```bash
POST /api/v1/files/upload-url
Content-Type: application/json

è¯·æ±‚ä½“ï¼š
{
  "fileName": "example.jpg",
  "contentType": "image/jpeg",
  "folder": "images"
}

å“åº”ï¼š
{
  "code": 200,
  "data": {
    "fileKey": "images/1/2024/01/01/20240101120000_abc123.jpg",
    "uploadToken": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "uploadUrl": "https://upload-z2.qiniup.com",
    "expiresIn": 3600
  }
}
```

#### 3. ç¡®è®¤ä¸Šä¼ 
```bash
POST /api/v1/files/confirm-upload
Content-Type: application/json

è¯·æ±‚ä½“ï¼š
{
  "fileKey": "images/1/2024/01/01/20240101120000_abc123.jpg",
  "fileSize": 1024000
}

å“åº”ï¼š
{
  "code": 200,
  "message": "ä¸Šä¼ ç¡®è®¤æˆåŠŸ"
}
```

### æ–‡ä»¶ä¸‹è½½æ¥å£

#### 1. ä¸‹è½½æ–‡ä»¶
```bash
GET /api/v1/files/download/{fileKey}

å“åº”ï¼š
- ä¸ƒç‰›äº‘æ–‡ä»¶ï¼š302é‡å®šå‘åˆ°ä¸ƒç‰›äº‘URL
- æœ¬åœ°æ–‡ä»¶ï¼šç›´æ¥è¿”å›æ–‡ä»¶æµ
```

#### 2. è·å–æ–‡ä»¶ä¿¡æ¯
```bash
GET /api/v1/files/info/{fileKey}

å“åº”ï¼š
{
  "code": 200,
  "data": {
    "exists": true,
    "fileKey": "images/1/2024/01/01/20240101120000_abc123.jpg",
    "url": "https://your-domain.com/images/1/2024/01/01/20240101120000_abc123.jpg",
    "storageType": "qiniu",
    "fileSize": 1024000,
    "lastModified": "2024-01-01T12:00:00"
  }
}
```

#### 3. æ£€æŸ¥æ–‡ä»¶å­˜åœ¨
```bash
GET /api/v1/files/exists/{fileKey}

å“åº”ï¼š
{
  "code": 200,
  "data": {
    "exists": true
  }
}
```

#### 4. åˆ é™¤æ–‡ä»¶
```bash
DELETE /api/v1/files/{fileKey}

å“åº”ï¼š
{
  "code": 200,
  "message": "åˆ é™¤æˆåŠŸ"
}
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æœåŠ¡å±‚è®¾è®¡
```
FileService (æ¥å£)
    â†“
FileServiceImpl (å®ç°ç±»)
    â”œâ”€â”€ ä¸ƒç‰›äº‘å­˜å‚¨æ–¹æ³•
    â”‚   â”œâ”€â”€ uploadToQiniu()
    â”‚   â”œâ”€â”€ deleteFromQiniu()
    â”‚   â”œâ”€â”€ getQiniuUrl()
    â”‚   â””â”€â”€ getQiniuUploadToken()
    â””â”€â”€ æœ¬åœ°å­˜å‚¨æ–¹æ³•
        â”œâ”€â”€ uploadToLocal()
        â”œâ”€â”€ deleteFromLocal()
        â””â”€â”€ getLocalFile()
```

### æ§åˆ¶å™¨å±‚è®¾è®¡
```
FileController
    â”œâ”€â”€ æ–‡ä»¶ä¸Šä¼ æ¥å£
    â”œâ”€â”€ æ–‡ä»¶ä¸‹è½½æ¥å£
    â”œâ”€â”€ æ–‡ä»¶ä¿¡æ¯æ¥å£
    â””â”€â”€ æ–‡ä»¶ç®¡ç†æ¥å£
```

## ğŸ”§ é…ç½®è¯´æ˜

### å¼€å‘ç¯å¢ƒé…ç½®
```properties
# ä½¿ç”¨æœ¬åœ°å­˜å‚¨
file.storage.type=local
file.upload.path=./uploads
file.upload.max-size=104857600
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®
```properties
# ä½¿ç”¨ä¸ƒç‰›äº‘å­˜å‚¨
file.storage.type=qiniu
qiniu.access-key=your_production_access_key
qiniu.secret-key=your_production_secret_key
qiniu.bucket=your_production_bucket
qiniu.domain=https://your-production-domain.com
qiniu.region=huadong
```

## ğŸ“Š æ€§èƒ½ç‰¹æ€§

### ä¸ƒç‰›äº‘å­˜å‚¨ç‰¹æ€§
- **é«˜å¯ç”¨æ€§**ï¼š99.9%+ å¯ç”¨æ€§ä¿è¯
- **CDNåŠ é€Ÿ**ï¼šå…¨çƒèŠ‚ç‚¹åŠ é€Ÿè®¿é—®
- **æ— é™æ‰©å±•**ï¼šå­˜å‚¨å®¹é‡æ— é™åˆ¶
- **æˆæœ¬ä¼˜åŒ–**ï¼šæŒ‰é‡è®¡è´¹ï¼Œæˆæœ¬å¯æ§
- **å®‰å…¨å¯é **ï¼šå¤šé‡å¤‡ä»½ï¼Œæ•°æ®å®‰å…¨

### æœ¬åœ°å­˜å‚¨ç‰¹æ€§
- **ç®€å•æ˜“ç”¨**ï¼šæ— å¤–éƒ¨ä¾èµ–
- **å¼€å‘å‹å¥½**ï¼šé€‚åˆå¼€å‘æµ‹è¯•
- **æˆæœ¬å¯æ§**ï¼šæ— é¢å¤–è´¹ç”¨
- **ç»´æŠ¤ç®€å•**ï¼šæ— éœ€å¤–éƒ¨æœåŠ¡

## ğŸ› ï¸ ä½¿ç”¨ç¤ºä¾‹

### 1. æ–‡ä»¶ä¸Šä¼ ç¤ºä¾‹

#### ç›´æ¥ä¸Šä¼ 
```javascript
const formData = new FormData();
formData.append('file', file);
formData.append('folder', 'images');

fetch('/api/v1/files/upload', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + token
  },
  body: formData
})
.then(response => response.json())
.then(data => {
  console.log('ä¸Šä¼ æˆåŠŸ:', data.data.url);
});
```

#### é¢„ç­¾åä¸Šä¼ 
```javascript
// 1. è·å–ä¸Šä¼ Token
const response = await fetch('/api/v1/files/upload-url', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + token
  },
  body: JSON.stringify({
    fileName: file.name,
    contentType: file.type,
    folder: 'images'
  })
});

const { fileKey, uploadToken, uploadUrl } = await response.json();

// 2. ç›´æ¥ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
const formData = new FormData();
formData.append('file', file);
formData.append('token', uploadToken);
formData.append('key', fileKey);

await fetch(uploadUrl, {
  method: 'POST',
  body: formData
});

// 3. ç¡®è®¤ä¸Šä¼ 
await fetch('/api/v1/files/confirm-upload', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + token
  },
  body: JSON.stringify({
    fileKey: fileKey,
    fileSize: file.size
  })
});
```

### 2. æ–‡ä»¶ä¸‹è½½ç¤ºä¾‹

```javascript
// è·å–æ–‡ä»¶ä¸‹è½½é“¾æ¥
const response = await fetch(`/api/v1/files/info/${fileKey}`, {
  headers: {
    'Authorization': 'Bearer ' + token
  }
});

const fileInfo = await response.json();
if (fileInfo.data.exists) {
  // ç›´æ¥ä½¿ç”¨URLè®¿é—®æ–‡ä»¶
  window.open(fileInfo.data.url);
}
```

## ğŸ”„ å­˜å‚¨æ–¹æ¡ˆåˆ‡æ¢

### ä»æœ¬åœ°å­˜å‚¨åˆ‡æ¢åˆ°ä¸ƒç‰›äº‘

1. **é…ç½®ä¸ƒç‰›äº‘å‚æ•°**
   ```properties
   qiniu.access-key=your_access_key
   qiniu.secret-key=your_secret_key
   qiniu.bucket=your_bucket_name
   qiniu.domain=https://your-domain.com
   ```

2. **ä¿®æ”¹å­˜å‚¨ç±»å‹**
   ```properties
   file.storage.type=qiniu
   ```

3. **é‡å¯åº”ç”¨**

### ä»ä¸ƒç‰›äº‘åˆ‡æ¢åˆ°æœ¬åœ°å­˜å‚¨

1. **ä¿®æ”¹å­˜å‚¨ç±»å‹**
   ```properties
   file.storage.type=local
   file.upload.path=/uploads
   ```

2. **é‡å¯åº”ç”¨**

## ğŸ“ æœ€ä½³å®è·µ

### 1. æ–‡ä»¶å‘½åè§„èŒƒ
```
æ ¼å¼ï¼š{folder}/{userId}/{year}/{month}/{day}/{timestamp}_{uuid}.{ext}
ç¤ºä¾‹ï¼šimages/1/2024/01/01/20240101120000_abc123.jpg
```

### 2. æ–‡ä»¶ç±»å‹é™åˆ¶
```java
// å…è®¸çš„æ–‡ä»¶ç±»å‹
private static final Set<String> ALLOWED_EXTENSIONS = Set.of(
    "jpg", "jpeg", "png", "gif", "pdf", "doc", "docx", 
    "txt", "zip", "rar", "mp4", "avi", "mov"
);
```

### 3. æ–‡ä»¶å¤§å°é™åˆ¶
```properties
# å•ä¸ªæ–‡ä»¶æœ€å¤§100MB
file.upload.max-size=104857600
spring.servlet.multipart.max-file-size=100MB
```

### 4. å®‰å…¨è€ƒè™‘
- æ–‡ä»¶ç±»å‹éªŒè¯
- æ–‡ä»¶å¤§å°é™åˆ¶
- ç”¨æˆ·æƒé™æ£€æŸ¥
- æ¶æ„æ–‡ä»¶æ£€æµ‹

## ğŸš€ éƒ¨ç½²å»ºè®®

### å¼€å‘ç¯å¢ƒ
- ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼š`file.storage.type=local`
- é…ç½®æœ¬åœ°è·¯å¾„ï¼š`file.upload.path=./uploads`
- è®¾ç½®æ–‡ä»¶å¤§å°é™åˆ¶

### æµ‹è¯•ç¯å¢ƒ
- å¯ä»¥ä½¿ç”¨ä¸ƒç‰›äº‘æµ‹è¯•å­˜å‚¨ç©ºé—´
- é…ç½®æµ‹è¯•åŸŸå
- éªŒè¯ä¸Šä¼ ä¸‹è½½åŠŸèƒ½

### ç”Ÿäº§ç¯å¢ƒ
- ä½¿ç”¨ä¸ƒç‰›äº‘å­˜å‚¨ï¼š`file.storage.type=qiniu`
- é…ç½®ç”Ÿäº§åŸŸåå’ŒCDN
- è®¾ç½®è®¿é—®æƒé™å’Œå®‰å…¨ç­–ç•¥

## ğŸ“ æŠ€æœ¯æ”¯æŒ

- **ä¸ƒç‰›äº‘æŠ€æœ¯æ”¯æŒ**ï¼šhttps://support.qiniu.com/
- **ä¸ƒç‰›äº‘æ–‡æ¡£**ï¼šhttps://developer.qiniu.com/
- **é¡¹ç›®æ–‡æ¡£**ï¼šæŸ¥çœ‹é¡¹ç›®READMEæ–‡ä»¶

---

é€šè¿‡ä»¥ä¸Šå®ç°ï¼ŒWikiçŸ¥è¯†åº“ç³»ç»Ÿç°åœ¨å…·å¤‡äº†å®Œæ•´çš„æ–‡ä»¶å­˜å‚¨åŠŸèƒ½ï¼Œæ”¯æŒä¸ƒç‰›äº‘å¯¹è±¡å­˜å‚¨å’Œæœ¬åœ°æ–‡ä»¶å­˜å‚¨ä¸¤ç§æ–¹æ¡ˆï¼Œå¯ä»¥æ ¹æ®ä¸åŒç¯å¢ƒçš„éœ€æ±‚çµæ´»åˆ‡æ¢ï¼Œä¸ºç§»åŠ¨ç«¯APPæä¾›ç¨³å®šå¯é çš„æ–‡ä»¶æœåŠ¡æ”¯æŒã€‚
