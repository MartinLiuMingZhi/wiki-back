name: Auto Merge Develop to Main

on:
  workflow_run:
    workflows: ["Release Workflow"]
    types: [completed]
    branches: [develop]
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Source branch to merge'
        required: true
        default: 'develop'
        type: string
      target_branch:
        description: 'Target branch to merge into'
        required: true
        default: 'main'
        type: string
      merge_strategy:
        description: 'Merge strategy'
        required: true
        default: 'no-ff'
        type: choice
        options:
        - no-ff
        - ff
        - squash

permissions:
  contents: write
  pull-requests: write
  actions: read

env:
  SOURCE_BRANCH: ${{ github.event.inputs.source_branch || 'develop' }}
  TARGET_BRANCH: ${{ github.event.inputs.target_branch || 'main' }}
  MERGE_STRATEGY: ${{ github.event.inputs.merge_strategy || 'no-ff' }}

jobs:
  # æ£€æŸ¥å·¥ä½œæµçŠ¶æ€
  check-workflow-status:
    name: Check Workflow Status
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run'
    outputs:
      should-merge: ${{ steps.check.outputs.should-merge }}
      release-version: ${{ steps.check.outputs.release-version }}
    
    steps:
    - name: Check workflow completion
      id: check
      run: |
        echo "ğŸ” Checking workflow completion status..."
        
        # æ£€æŸ¥Releaseå·¥ä½œæµæ˜¯å¦æˆåŠŸå®Œæˆ
        if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
          echo "should-merge=true" >> $GITHUB_OUTPUT
          echo "âœ… Release workflow completed successfully"
        else
          echo "should-merge=false" >> $GITHUB_OUTPUT
          echo "âŒ Release workflow failed or was cancelled"
        fi
        
        # å°è¯•ä»å·¥ä½œæµè¿è¡Œä¸­æå–ç‰ˆæœ¬ä¿¡æ¯
        echo "release-version=unknown" >> $GITHUB_OUTPUT

  # è‡ªåŠ¨åˆå¹¶åˆ†æ”¯
  auto-merge:
    name: Auto Merge Branches
    runs-on: ubuntu-latest
    needs: [check-workflow-status]
    if: |
      (github.event_name == 'workflow_dispatch') || 
      (github.event_name == 'workflow_run' && needs.check-workflow-status.outputs.should-merge == 'true')
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions Auto-Merge"
        git config --global user.email "actions@github.com"
        git config --global pull.rebase false
        git config --global merge.tool false
        
    - name: Pre-merge checks
      id: pre-checks
      run: |
        echo "ğŸ” Performing pre-merge checks..."
        
        # è·å–æœ€æ–°ä¿¡æ¯
        git fetch origin
        
        # æ£€æŸ¥æºåˆ†æ”¯æ˜¯å¦å­˜åœ¨
        if ! git show-ref --verify --quiet refs/remotes/origin/${{ env.SOURCE_BRANCH }}; then
          echo "âŒ Source branch ${{ env.SOURCE_BRANCH }} does not exist"
          exit 1
        fi
        
        # æ£€æŸ¥ç›®æ ‡åˆ†æ”¯æ˜¯å¦å­˜åœ¨
        if ! git show-ref --verify --quiet refs/remotes/origin/${{ env.TARGET_BRANCH }}; then
          echo "âŒ Target branch ${{ env.TARGET_BRANCH }} does not exist"
          exit 1
        fi
        
        # åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯
        git checkout ${{ env.TARGET_BRANCH }}
        git pull origin ${{ env.TARGET_BRANCH }}
        
        # åˆ‡æ¢åˆ°æºåˆ†æ”¯
        git checkout ${{ env.SOURCE_BRANCH }}
        git pull origin ${{ env.SOURCE_BRANCH }}
        
        # æ£€æŸ¥æ˜¯å¦å·²ç»åˆå¹¶
        if git merge-base --is-ancestor ${{ env.SOURCE_BRANCH }} ${{ env.TARGET_BRANCH }}; then
          echo "is-already-merged=true" >> $GITHUB_OUTPUT
          echo "âœ… ${{ env.SOURCE_BRANCH }} is already merged into ${{ env.TARGET_BRANCH }}"
        else
          echo "is-already-merged=false" >> $GITHUB_OUTPUT
          echo "ğŸ”„ ${{ env.SOURCE_BRANCH }} needs to be merged into ${{ env.TARGET_BRANCH }}"
        fi
        
        # æ£€æŸ¥åˆå¹¶å†²çª
        git checkout ${{ env.TARGET_BRANCH }}
        if git merge-tree $(git merge-base ${{ env.SOURCE_BRANCH }} ${{ env.TARGET_BRANCH }}) ${{ env.SOURCE_BRANCH }} ${{ env.TARGET_BRANCH }} | grep -q "<<<<<<<"; then
          echo "has-conflicts=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ Merge conflicts detected"
        else
          echo "has-conflicts=false" >> $GITHUB_OUTPUT
          echo "âœ… No merge conflicts detected"
        fi
        
    - name: Skip merge (already merged)
      if: steps.pre-checks.outputs.is-already-merged == 'true'
      run: |
        echo "â„¹ï¸ ${{ env.SOURCE_BRANCH }} is already merged into ${{ env.TARGET_BRANCH }}, skipping merge operation"
        
    - name: Handle merge conflicts
      if: steps.pre-checks.outputs.has-conflicts == 'true'
      run: |
        echo "âŒ Merge conflicts detected between ${{ env.SOURCE_BRANCH }} and ${{ env.TARGET_BRANCH }}"
        echo "Please resolve conflicts manually and try again."
        echo ""
        echo "To resolve conflicts:"
        echo "1. Checkout ${{ env.TARGET_BRANCH }}"
        echo "2. Merge ${{ env.SOURCE_BRANCH }} manually"
        echo "3. Resolve conflicts"
        echo "4. Commit and push"
        exit 1
        
    - name: Perform merge
      if: steps.pre-checks.outputs.is-already-merged == 'false' && steps.pre-checks.outputs.has-conflicts == 'false'
      run: |
        echo "ğŸ”„ Merging ${{ env.SOURCE_BRANCH }} into ${{ env.TARGET_BRANCH }}..."
        
        # åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯
        git checkout ${{ env.TARGET_BRANCH }}
        git pull origin ${{ env.TARGET_BRANCH }}
        
        # æ ¹æ®ç­–ç•¥æ‰§è¡Œåˆå¹¶
        if [ "${{ env.MERGE_STRATEGY }}" = "squash" ]; then
          echo "ğŸ“¦ Using squash merge strategy"
          git merge --squash ${{ env.SOURCE_BRANCH }}
          git commit -m "Merge ${{ env.SOURCE_BRANCH }} into ${{ env.TARGET_BRANCH }}

          - Source: ${{ env.SOURCE_BRANCH }}
          - Target: ${{ env.TARGET_BRANCH }}
          - Strategy: squash
          - Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          - Workflow: ${{ github.workflow }}
          - Run ID: ${{ github.run_id }}"
        elif [ "${{ env.MERGE_STRATEGY }}" = "ff" ]; then
          echo "âš¡ Using fast-forward merge strategy"
          git merge --ff-only ${{ env.SOURCE_BRANCH }}
        else
          echo "ğŸ”„ Using no-fast-forward merge strategy"
          git merge --no-ff ${{ env.SOURCE_BRANCH }} -m "Merge ${{ env.SOURCE_BRANCH }} into ${{ env.TARGET_BRANCH }}

          - Source: ${{ env.SOURCE_BRANCH }}
          - Target: ${{ env.TARGET_BRANCH }}
          - Strategy: no-ff
          - Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          - Workflow: ${{ github.workflow }}
          - Run ID: ${{ github.run_id }}"
        fi
        
        # æ¨é€åˆå¹¶ç»“æœ
        git push origin ${{ env.TARGET_BRANCH }}
        
        echo "âœ… Successfully merged ${{ env.SOURCE_BRANCH }} into ${{ env.TARGET_BRANCH }}"
        
    - name: Create merge notification
      if: always()
      run: |
        echo "ğŸ“¢ Auto-merge operation completed:"
        echo "  - Source: ${{ env.SOURCE_BRANCH }}"
        echo "  - Target: ${{ env.TARGET_BRANCH }}"
        echo "  - Strategy: ${{ env.MERGE_STRATEGY }}"
        echo "  - Already merged: ${{ steps.pre-checks.outputs.is-already-merged }}"
        echo "  - Has conflicts: ${{ steps.pre-checks.outputs.has-conflicts }}"
        echo "  - Current commit: $(git rev-parse HEAD)"
        echo "  - Workflow: ${{ github.workflow }}"
        echo "  - Run ID: ${{ github.run_id }}"
        
        if [ "${{ steps.pre-checks.outputs.is-already-merged }}" = "true" ]; then
          echo "âœ… Merge operation completed successfully (already merged)"
        elif [ "${{ steps.pre-checks.outputs.has-conflicts }}" = "true" ]; then
          echo "âŒ Merge operation failed due to conflicts"
        else
          echo "âœ… Merge operation completed successfully"
        fi

  # åç½®æ£€æŸ¥
  post-merge-check:
    name: Post-Merge Check
    runs-on: ubuntu-latest
    needs: [auto-merge]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Verify merge result
      run: |
        echo "ğŸ” Verifying merge result..."
        
        git fetch origin
        git checkout ${{ env.TARGET_BRANCH }}
        git pull origin ${{ env.TARGET_BRANCH }}
        
        # æ£€æŸ¥åˆå¹¶æ˜¯å¦æˆåŠŸ
        if git merge-base --is-ancestor ${{ env.SOURCE_BRANCH }} ${{ env.TARGET_BRANCH }}; then
          echo "âœ… Merge verification successful"
          echo "  - ${{ env.SOURCE_BRANCH }} is now part of ${{ env.TARGET_BRANCH }}"
        else
          echo "âŒ Merge verification failed"
          echo "  - ${{ env.SOURCE_BRANCH }} is not part of ${{ env.TARGET_BRANCH }}"
          exit 1
        fi
        
        # æ˜¾ç¤ºæœ€è¿‘çš„æäº¤
        echo "ğŸ“‹ Recent commits in ${{ env.TARGET_BRANCH }}:"
        git log --oneline -5
        
    - name: Final notification
      if: always()
      run: |
        echo "ğŸ‰ Auto-merge process completed!"
        echo "  - Source: ${{ env.SOURCE_BRANCH }}"
        echo "  - Target: ${{ env.TARGET_BRANCH }}"
        echo "  - Status: ${{ needs.auto-merge.result }}"
        echo "  - Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
