name: 🤖 Dependabot Auto-merge

on:
  pull_request:
    types: [opened, synchronize, labeled, ready_for_review]
  pull_request_target:
    types: [opened, synchronize, labeled, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # 检查依赖更新安全性
  check-dependency-safety:
    name: Check Dependency Safety
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    outputs:
      is-safe: ${{ steps.check.outputs.is-safe }}
      has-auto-merge-label: ${{ steps.check.outputs.has-auto-merge-label }}
    
    steps:
    - name: Check dependency safety
      id: check
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_LABELS="${{ toJson(github.event.pull_request.labels) }}"
        
        echo "PR Title: $PR_TITLE"
        echo "PR Labels: $PR_LABELS"
        
        # 检查是否有 auto-merge 标签
        if echo "$PR_LABELS" | grep -q "auto-merge"; then
          echo "has-auto-merge-label=true" >> $GITHUB_OUTPUT
          echo "✅ Auto-merge label found"
        else
          echo "has-auto-merge-label=false" >> $GITHUB_OUTPUT
          echo "⚠️ No auto-merge label found"
        fi
        
        # 检查是否为patch版本更新
        if echo "$PR_TITLE" | grep -q "Bump.*from.*to.*"; then
          if echo "$PR_TITLE" | grep -q "patch\|bugfix"; then
            echo "is-safe=true" >> $GITHUB_OUTPUT
            echo "✅ Patch version update - safe to auto-merge"
          else
            echo "is-safe=false" >> $GITHUB_OUTPUT
            echo "⚠️ Minor version update - requires manual review"
          fi
        else
          echo "is-safe=false" >> $GITHUB_OUTPUT
          echo "❌ Unknown update type - requires manual review"
        fi

  # 自动合并安全的依赖更新
  auto-merge:
    name: Auto-merge Safe Dependencies
    runs-on: ubuntu-latest
    needs: [check-dependency-safety]
    if: |
      github.actor == 'dependabot[bot]' && 
      needs.check-dependency-safety.outputs.is-safe == 'true' && 
      needs.check-dependency-safety.outputs.has-auto-merge-label == 'true'
    
    steps:
    - name: Auto-merge Dependabot PRs
      uses: fastify/github-action-merge-dependabot@v3
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        target: patch
        merge-method: squash
        merge-commit-message: |
          chore: auto-merge dependabot PR
          
          - PR: ${{ github.event.pull_request.html_url }}
          - Title: ${{ github.event.pull_request.title }}
          - Auto-merged by: Dependabot Auto-merge workflow
        
    - name: Notify merge
      if: success()
      run: |
        echo "✅ Safe dependency update merged successfully"
        echo "PR: ${{ github.event.pull_request.html_url }}"
        echo "Title: ${{ github.event.pull_request.title }}"

  # 通知需要手动审查的更新
  notify-manual-review:
    name: Notify Manual Review Required
    runs-on: ubuntu-latest
    needs: [check-dependency-safety]
    if: github.actor == 'dependabot[bot]' && needs.check-dependency-safety.outputs.is-safe == 'false'
    
    steps:
    - name: Notify manual review
      run: |
        echo "⚠️ Manual review required for dependency update"
        echo "PR: ${{ github.event.pull_request.html_url }}"
        echo "Title: ${{ github.event.pull_request.title }}"
        echo "Please review the changes and merge manually if safe."
